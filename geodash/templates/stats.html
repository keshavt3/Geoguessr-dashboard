{% extends "base.html" %}

{% block title %}Stats - GeoGuessr Dashboard{% endblock %}

{% block content %}
<h1>GeoGuessr Statistics</h1>

<div id="filters">
    <div class="filter-group">
        <label for="gameType">Game Type:</label>
        <select id="gameType">
            <option value="duels">Solo Duels</option>
            <option value="team_duels">Team Duels</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="mode">Mode:</label>
        <select id="mode">
            <option value="all">All Games</option>
            <option value="competitive">Competitive</option>
            <option value="casual">Casual</option>
        </select>
    </div>
    <div class="filter-group" id="teammate-filter" style="display: none;">
        <label for="teammate">Teammate:</label>
        <select id="teammate">
            <option value="">All Teammates</option>
        </select>
    </div>
</div>

<div id="loading">Loading stats...</div>
<div id="no-stats" style="display: none;">
    <p>No stats found for this filter. <a href="{{ url_for('show_fetch') }}">Fetch some games first</a>.</p>
</div>

<div id="stats-container" style="display: none;">
    <section id="overall-stats">
        <h2>Overall Stats</h2>
        <div class="stats-grid" id="overall-grid"></div>
    </section>

    <section id="player-contributions" style="display: none;">
        <h2>Player Contributions</h2>
        <div id="contributions-grid"></div>
    </section>

    <section id="country-stats">
        <h2>Country Performance</h2>

        <div class="country-section">
            <h3>Top 10 Countries (by Score Diff)</h3>
            <table id="top-countries">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Rounds</th>
                        <th>Avg Score</th>
                        <th>Score Diff</th>
                        <th>Win Rate</th>
                        <th>Hit Rate</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="country-section">
            <h3>Bottom 10 Countries (by Score Diff)</h3>
            <table id="bottom-countries">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Rounds</th>
                        <th>Avg Score</th>
                        <th>Score Diff</th>
                        <th>Win Rate</th>
                        <th>Hit Rate</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section id="world-map-section">
        <h2>World Map</h2>
        <p class="map-legend">
            <span class="legend-item"><span class="legend-color score-3"></span> +200+</span>
            <span class="legend-item"><span class="legend-color score-2"></span> +100 to +200</span>
            <span class="legend-item"><span class="legend-color score-1"></span> 0 to +100</span>
            <span class="legend-item"><span class="legend-color score--1"></span> -100 to 0</span>
            <span class="legend-item"><span class="legend-color score--2"></span> -200 to -100</span>
            <span class="legend-item"><span class="legend-color score--3"></span> -200-</span>
            <span class="legend-item"><span class="legend-color unplayed"></span> No Data</span>
        </p>
        <div id="map-container">
            <p id="map-loading">Loading map...</p>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
const gameTypeSelect = document.getElementById('gameType');
const modeSelect = document.getElementById('mode');
const teammateSelect = document.getElementById('teammate');
const teammateFilter = document.getElementById('teammate-filter');

// Store countries data for map coloring
let allCountriesData = [];
let mapLoaded = false;

// Load the SVG map on page load
async function loadWorldMap() {
    const container = document.getElementById('map-container');
    try {
        const response = await fetch('/static/svg/world-map.svg');
        if (!response.ok) throw new Error('Failed to load map');
        const svgText = await response.text();
        container.innerHTML = svgText;
        mapLoaded = true;
        // Color the map if we already have data
        if (allCountriesData.length > 0) {
            updateWorldMap(allCountriesData);
        }
    } catch (err) {
        container.innerHTML = '<p class="error">Could not load map</p>';
        console.error('Error loading map:', err);
    }
}

function updateWorldMap(countries) {
    if (!mapLoaded) return;

    // Build lookup by country code (lowercase)
    const countryLookup = {};
    countries.forEach(c => {
        countryLookup[c.country_code.toLowerCase()] = c;
    });

    // Get all elements with IDs in the map (both paths and groups)
    const mapContainer = document.querySelector('#map-container svg');
    if (!mapContainer) return;

    // Process all elements with an id attribute
    const elementsWithId = mapContainer.querySelectorAll('[id]');

    elementsWithId.forEach(element => {
        const code = element.id.toLowerCase();
        // Skip non-country IDs (like "world-map")
        if (code === 'world-map' || code.length > 3) return;

        const stats = countryLookup[code];

        // Get all paths within this element (or the element itself if it's a path)
        const paths = element.tagName === 'path' ? [element] : element.querySelectorAll('path');

        paths.forEach(path => {
            // Reset classes
            path.classList.remove('played', 'score-3', 'score-2', 'score-1', 'score--1', 'score--2', 'score--3');

            if (stats && stats.rounds > 0) {
                path.classList.add('played');

                // Color based on avg_score_diff (6-tier gradient)
                const diff = stats.avg_score_diff;
                if (diff >= 200) {
                    path.classList.add('score-3');      // Dark green
                } else if (diff >= 100) {
                    path.classList.add('score-2');      // Medium green
                } else if (diff >= 0) {
                    path.classList.add('score-1');      // Light green
                } else if (diff >= -100) {
                    path.classList.add('score--1');     // Yellow/Gold
                } else if (diff >= -200) {
                    path.classList.add('score--2');     // Orange
                } else {
                    path.classList.add('score--3');     // Red
                }

                // Add click handler
                path.onclick = (e) => {
                    e.stopPropagation();
                    navigateToCountry(code);
                };
            } else {
                // Remove click handler for unplayed countries
                path.onclick = null;
            }
        });
    });
}

function navigateToCountry(countryCode) {
    const gameType = gameTypeSelect.value;
    const mode = modeSelect.value;
    const teammate = teammateSelect.value;

    let url = `/countries/${countryCode}/?game_type=${gameType}&mode=${mode}`;
    if (teammate) {
        url += `&teammate=${teammate}`;
    }
    window.location.href = url;
}

// Load map on page load
loadWorldMap();

// Load stats when filters change
gameTypeSelect.addEventListener('change', onGameTypeChange);
modeSelect.addEventListener('change', loadStats);
teammateSelect.addEventListener('change', loadStats);

async function onGameTypeChange() {
    const gameType = gameTypeSelect.value;

    if (gameType === 'team_duels') {
        teammateFilter.style.display = 'flex';
        await loadTeammates();
    } else {
        teammateFilter.style.display = 'none';
        teammateSelect.value = '';
    }

    loadStats();
}

async function loadTeammates() {
    try {
        const res = await fetch('/api/v1/teammates/');
        const data = await res.json();

        if (data.success && data.teammates) {
            // Keep "All Teammates" option
            teammateSelect.innerHTML = '<option value="">All Teammates</option>';

            data.teammates.forEach(t => {
                const option = document.createElement('option');
                option.value = t.player_id;
                option.textContent = `${t.username} (${t.games_played} games)`;
                teammateSelect.appendChild(option);
            });
        }
    } catch (err) {
        console.error('Error loading teammates:', err);
    }
}

async function loadStats() {
    const loading = document.getElementById('loading');
    const noStats = document.getElementById('no-stats');
    const container = document.getElementById('stats-container');

    const gameType = gameTypeSelect.value;
    const mode = modeSelect.value;
    const teammate = teammateSelect.value;

    loading.style.display = 'block';
    noStats.style.display = 'none';
    container.style.display = 'none';

    try {
        // Build query string
        let queryParams = `game_type=${gameType}&mode=${mode}`;
        if (teammate) {
            queryParams += `&teammate=${teammate}`;
        }

        // Fetch overall stats with filters
        const statsRes = await fetch(`/api/v1/stats/?${queryParams}`);
        const statsData = await statsRes.json();

        if (!statsData.success) {
            loading.style.display = 'none';
            noStats.style.display = 'block';
            return;
        }

        // Fetch country stats with filters
        const countriesRes = await fetch(`/api/v1/countries/?${queryParams}`);
        const countriesData = await countriesRes.json();

        // Render overall stats
        const overall = statsData.data.overall;
        const overallGrid = document.getElementById('overall-grid');
        overallGrid.innerHTML = `
            <div class="stat-card">
                <h3>Total Games</h3>
                <p>${overall.total_games}</p>
            </div>
            <div class="stat-card">
                <h3>Win Rate</h3>
                <p>${(overall.win_percentage * 100).toFixed(1)}%</p>
            </div>
            <div class="stat-card">
                <h3>Avg Rounds/Game</h3>
                <p>${overall.avg_rounds_per_game.toFixed(2)}</p>
            </div>
            ${overall.avg_score ? `
            <div class="stat-card">
                <h3>Avg Score</h3>
                <p>${overall.avg_score.toFixed(0)}</p>
            </div>` : ''}
            ${overall.total_5ks ? `
            <div class="stat-card">
                <h3>Total 5Ks</h3>
                <p>${overall.total_5ks}</p>
            </div>` : ''}
            ${overall.avg_guess_time ? `
            <div class="stat-card">
                <h3>Avg Guess Time</h3>
                <p>${overall.avg_guess_time.toFixed(1)}s</p>
            </div>` : ''}
            <div class="stat-card">
                <h3>Multi-Merchanted</h3>
                <p>${overall.multi_merchant}</p>
            </div>
            <div class="stat-card">
                <h3>Reverse Merchanted</h3>
                <p>${overall.reverse_merchant}</p>
            </div>
        `;

        // Render player contributions if available
        const contributions = statsData.data.player_contributions;
        const contribSection = document.getElementById('player-contributions');
        const contribGrid = document.getElementById('contributions-grid');

        if (contributions && contributions.length > 0) {
            contribSection.style.display = 'block';
            contribGrid.innerHTML = contributions.map(p => `
                <div class="player-card">
                    <h4>${p.username || p.player_id}</h4>
                    <p class="games-count">${p.games_played} games</p>
                    <p>Contribution: ${(p.contribution_percent * 100).toFixed(1)}%</p>
                    ${p.avg_individual_score ? `<p>Avg Score: ${p.avg_individual_score.toFixed(0)}</p>` : ''}
                    ${p.total_5ks ? `<p>5Ks: ${p.total_5ks}</p>` : ''}
                    ${p.avg_guess_time ? `<p>Avg Time: ${p.avg_guess_time.toFixed(1)}s</p>` : ''}
                </div>
            `).join('');
        } else {
            contribSection.style.display = 'none';
        }

        // Render country tables and update map
        if (countriesData.success) {
            renderCountryTable('top-countries', countriesData.data.top_10);
            renderCountryTable('bottom-countries', countriesData.data.bottom_10);

            // Store all countries data and update the map
            allCountriesData = countriesData.data.all_countries || [];
            updateWorldMap(allCountriesData);
        }

        loading.style.display = 'none';
        container.style.display = 'block';

    } catch (err) {
        loading.innerHTML = `<p class="error">Error loading stats: ${err.message}</p>`;
    }
}

function renderCountryTable(tableId, countries) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    if (!countries || countries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
        return;
    }
    tbody.innerHTML = countries.map(c => `
        <tr>
            <td>${c.country_code.toUpperCase()}</td>
            <td>${c.rounds}</td>
            <td>${c.avg_score.toFixed(0)}</td>
            <td>${c.avg_score_diff >= 0 ? '+' : ''}${c.avg_score_diff.toFixed(0)}</td>
            <td>${(c.win_rate * 100).toFixed(1)}%</td>
            <td>${(c.hit_rate * 100).toFixed(1)}%</td>
        </tr>
    `).join('');
}

// Load stats on page load
loadStats();
</script>
{% endblock %}
