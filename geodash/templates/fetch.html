{% extends "base.html" %}

{% block title %}Fetch Stats - GeoGuessr Dashboard{% endblock %}

{% block content %}
<h1>Fetch Games</h1>

<p>Enter your credentials to fetch all your GeoGuessr games (both Solo Duels and Team Duels).</p>

<form id="fetch-form">
    <div class="form-group" id="playerId-group">
        <label for="playerId">Player ID:</label>
        <input type="text" id="playerId" name="playerId" required>
        <span class="inline-error-message" id="playerId-error"></span>
    </div>

    <div class="form-group" id="ncfa-group">
        <label for="ncfa">NCFA Cookie:</label>
        <input type="text" id="ncfa" name="ncfa" required>
        <span class="inline-error-message" id="ncfa-error"></span>
    </div>

    <button type="submit" id="fetch-btn">Fetch All Games</button>
</form>

<div id="progress-container" class="progress-container hidden">
    <div class="progress-phases">
        <div class="phase" data-phase="1">
            <span class="phase-indicator"></span>
            <span class="phase-name">Fetching Duel tokens</span>
            <span class="phase-status"></span>
        </div>
        <div class="phase" data-phase="2">
            <span class="phase-indicator"></span>
            <span class="phase-name">Fetching Duel games</span>
            <span class="phase-status"></span>
        </div>
        <div class="phase" data-phase="3">
            <span class="phase-indicator"></span>
            <span class="phase-name">Fetching Team Duel tokens</span>
            <span class="phase-status"></span>
        </div>
        <div class="phase" data-phase="4">
            <span class="phase-indicator"></span>
            <span class="phase-name">Fetching Team Duel games</span>
            <span class="phase-status"></span>
        </div>
        <div class="phase" data-phase="5">
            <span class="phase-indicator"></span>
            <span class="phase-name">Fetching player usernames</span>
            <span class="phase-status"></span>
        </div>
        <div class="phase" data-phase="6">
            <span class="phase-indicator"></span>
            <span class="phase-name">Computing statistics</span>
            <span class="phase-status"></span>
        </div>
    </div>
</div>

<div id="status"></div>

<!-- Error Alert Modal -->
<div id="error-overlay" class="error-overlay hidden">
    <div class="error-alert">
        <div class="error-alert-header">
            <div class="error-alert-icon"></div>
            <h3>Error</h3>
        </div>
        <p id="error-message" class="error-alert-message"></p>
        <button id="error-close" class="error-alert-close">Dismiss</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Error modal functions
const errorOverlay = document.getElementById('error-overlay');
const errorMessage = document.getElementById('error-message');
const errorClose = document.getElementById('error-close');

function showError(message) {
    errorMessage.textContent = message;
    errorOverlay.classList.remove('hidden');
}

function hideError() {
    errorOverlay.classList.add('hidden');
}

// Inline error functions
function showInlineError(field, message) {
    const group = document.getElementById(`${field}-group`);
    const errorSpan = document.getElementById(`${field}-error`);
    if (group && errorSpan) {
        group.classList.add('has-error');
        errorSpan.textContent = message;
    }
}

function clearInlineError(field) {
    const group = document.getElementById(`${field}-group`);
    const errorSpan = document.getElementById(`${field}-error`);
    if (group && errorSpan) {
        group.classList.remove('has-error');
        errorSpan.textContent = '';
    }
}

function clearAllInlineErrors() {
    clearInlineError('playerId');
    clearInlineError('ncfa');
}

function resetAllPhases() {
    document.querySelectorAll('.phase').forEach(phase => {
        phase.classList.remove('in-progress', 'complete', 'error');
        phase.querySelector('.phase-status').textContent = '';
    });
}

function markCurrentPhaseAsError() {
    // Find any in-progress phase and mark it as error
    document.querySelectorAll('.phase.in-progress').forEach(phase => {
        phase.classList.remove('in-progress');
        phase.classList.add('error');
        phase.querySelector('.phase-status').textContent = '(failed)';
    });
}

errorClose.addEventListener('click', hideError);
errorOverlay.addEventListener('click', function(e) {
    if (e.target === errorOverlay) {
        hideError();
    }
});

// Clear inline errors when user starts typing
document.getElementById('playerId').addEventListener('input', function() {
    clearInlineError('playerId');
});
document.getElementById('ncfa').addEventListener('input', function() {
    clearInlineError('ncfa');
});

document.getElementById('fetch-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const statusDiv = document.getElementById('status');
    const progressContainer = document.getElementById('progress-container');
    const btn = document.getElementById('fetch-btn');

    const playerId = document.getElementById('playerId').value;
    const ncfa = document.getElementById('ncfa').value;

    btn.disabled = true;
    statusDiv.innerHTML = '';
    progressContainer.classList.remove('hidden');

    // Clear any previous errors
    clearAllInlineErrors();

    // Reset all phases
    resetAllPhases();

    // Use SSE endpoint
    const url = `/api/v1/fetch-all-stream/?playerId=${encodeURIComponent(playerId)}&ncfa=${encodeURIComponent(ncfa)}`;
    const eventSource = new EventSource(url);

    eventSource.addEventListener('phase', function(e) {
        const data = JSON.parse(e.data);
        const phaseEl = document.querySelector(`.phase[data-phase="${data.phase}"]`);

        if (phaseEl) {
            if (data.status === 'in_progress') {
                phaseEl.classList.add('in-progress');
                phaseEl.classList.remove('complete');
                if (data.total !== undefined && data.total > 0) {
                    phaseEl.querySelector('.phase-status').textContent = `(0/${data.total})`;
                } else if (data.total === 0) {
                    phaseEl.querySelector('.phase-status').textContent = `(0 new games)`;
                }
            } else if (data.status === 'complete') {
                phaseEl.classList.remove('in-progress');
                phaseEl.classList.add('complete');

                let statusText = '';
                if (data.count !== undefined) {
                    statusText = `(${data.count} found)`;
                } else if (data.new !== undefined && data.total !== undefined) {
                    statusText = `(${data.new} new, ${data.total} total)`;
                }
                phaseEl.querySelector('.phase-status').textContent = statusText;
            }
        }
    });

    eventSource.addEventListener('progress', function(e) {
        const data = JSON.parse(e.data);
        const phaseEl = document.querySelector(`.phase[data-phase="${data.phase}"]`);

        if (phaseEl) {
            phaseEl.querySelector('.phase-status').textContent = `(${data.current}/${data.total})`;
        }
    });

    eventSource.addEventListener('complete', function(e) {
        const data = JSON.parse(e.data);
        eventSource.close();

        let msg = `<strong>Fetch complete!</strong><br>`;
        msg += `Solo Duels: ${data.duels_fetched} new (${data.duels_total} total)<br>`;
        msg += `Team Duels: ${data.team_duels_fetched} new (${data.team_duels_total} total)`;
        statusDiv.innerHTML = `<p class="success">${msg}<br><br><a href="/stats/">View Stats</a></p>`;
        btn.disabled = false;
    });

    eventSource.addEventListener('error', function(e) {
        markCurrentPhaseAsError();
        eventSource.close();
        btn.disabled = false;

        if (e.data) {
            const data = JSON.parse(e.data);
            // Check if this is a field-specific error
            if (data.field) {
                showInlineError(data.field, data.error);
            } else {
                showError(data.error);
            }
        } else {
            showError('Connection to the server was lost. This sometimes happens with the GeoGuessr API. Please try again.');
        }
    });

    eventSource.onerror = function() {
        // Only show error if not already closed
        if (eventSource.readyState !== EventSource.CLOSED) {
            markCurrentPhaseAsError();
            eventSource.close();
            btn.disabled = false;
            showError('Connection to the server was lost. This sometimes happens with the GeoGuessr API. Please try again.');
        }
    };
});
</script>
{% endblock %}
