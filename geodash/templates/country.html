{% extends "base.html" %}

{% block title %}{{ country_code|upper }} Stats - GeoGuessr Dashboard{% endblock %}

{% block content %}
<h1>Country: <span id="country-name">{{ country_code|upper }}</span></h1>

<a href="{{ url_for('show_stats') }}" class="back-link">&larr; Back to Stats</a>

<div id="filters">
    <div class="filter-group">
        <label for="gameType">Game Type:</label>
        <select id="gameType">
            <option value="duels">Solo Duels</option>
            <option value="team_duels">Team Duels</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="mode">Mode:</label>
        <select id="mode">
            <option value="all">All Games</option>
            <option value="competitive">Competitive</option>
            <option value="casual">Casual</option>
        </select>
    </div>
    <div class="filter-group" id="teammate-filter" style="display: none;">
        <label for="teammate">Teammate:</label>
        <select id="teammate">
            <option value="">All Teammates</option>
        </select>
    </div>
</div>

<div id="loading">Loading country stats...</div>
<div id="no-stats" style="display: none;">
    <p>No stats found for this country with the selected filters.</p>
</div>

<div id="country-stats-container" style="display: none;">
    <section id="country-detail-stats">
        <h2>Performance Statistics</h2>
        <div class="stats-grid" id="country-stats-grid"></div>
    </section>

    <section id="heatmap-section">
        <h2>Guess vs Actual Locations</h2>
        <div class="heatmap-controls">
            <label><input type="checkbox" id="showActual" checked> <span class="dot actual-dot"></span> Actual Locations</label>
            <label><input type="checkbox" id="showGuess" checked> <span class="dot guess-dot"></span> Guess Locations</label>
        </div>
        <div id="heatmap" style="height: 400px; border-radius: 8px;"></div>
        <p id="heatmap-note" class="note"></p>
    </section>

    <section id="wrong-guesses-section">
        <h2>Most Common Wrong Guesses</h2>
        <p class="section-desc">Countries you most often guess incorrectly when the actual location is {{ country_code|upper }}</p>
        <div id="wrong-guesses-chart"></div>
        <p id="wrong-guesses-note" class="note"></p>
    </section>

    <section id="distance-section">
        <h2>Distance Error Distribution</h2>
        <div class="stats-grid" id="distance-stats"></div>
        <div id="distance-chart"></div>
    </section>

    <section id="regions-section">
        <h2>Hardest Regions</h2>
        <p class="section-desc">Regions within {{ country_code|upper }} ranked by average guess error (hardest first)</p>
        <table id="regions-table">
            <thead>
                <tr>
                    <th>Region</th>
                    <th>Rounds</th>
                    <th>Avg Distance</th>
                    <th>Difficulty</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="regions-note" class="note"></p>
    </section>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const countryCode = "{{ country_code }}";
const gameTypeSelect = document.getElementById('gameType');
const modeSelect = document.getElementById('mode');
const teammateSelect = document.getElementById('teammate');
const teammateFilter = document.getElementById('teammate-filter');

let map = null;
let actualLayer = null;
let guessLayer = null;
let detailsData = null;

// Parse URL params and set filter dropdowns
const urlParams = new URLSearchParams(window.location.search);
const initialGameType = urlParams.get('game_type') || 'duels';
const initialMode = urlParams.get('mode') || 'all';
const initialTeammate = urlParams.get('teammate') || '';

// Set initial filter values
gameTypeSelect.value = initialGameType;
modeSelect.value = initialMode;

// Load stats when filters change
gameTypeSelect.addEventListener('change', onGameTypeChange);
modeSelect.addEventListener('change', loadCountryStats);
teammateSelect.addEventListener('change', loadCountryStats);

// Heatmap toggle controls
document.getElementById('showActual').addEventListener('change', updateMapLayers);
document.getElementById('showGuess').addEventListener('change', updateMapLayers);

async function onGameTypeChange() {
    const gameType = gameTypeSelect.value;

    if (gameType === 'team_duels') {
        teammateFilter.style.display = 'flex';
        await loadTeammates();
    } else {
        teammateFilter.style.display = 'none';
        teammateSelect.value = '';
    }

    updateURLParams();
    loadCountryStats();
}

function updateURLParams() {
    const params = new URLSearchParams();
    params.set('game_type', gameTypeSelect.value);
    params.set('mode', modeSelect.value);
    if (teammateSelect.value) {
        params.set('teammate', teammateSelect.value);
    }
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.replaceState({}, '', newUrl);
}

async function loadTeammates() {
    try {
        const res = await fetch('/api/v1/teammates/');
        const data = await res.json();

        if (data.success && data.teammates) {
            teammateSelect.innerHTML = '<option value="">All Teammates</option>';

            data.teammates.forEach(t => {
                const option = document.createElement('option');
                option.value = t.player_id;
                option.textContent = `${t.username} (${t.games_played} games)`;
                teammateSelect.appendChild(option);
            });
        }
    } catch (err) {
        console.error('Error loading teammates:', err);
    }
}

async function loadCountryStats() {
    const loading = document.getElementById('loading');
    const noStats = document.getElementById('no-stats');
    const container = document.getElementById('country-stats-container');

    const gameType = gameTypeSelect.value;
    const mode = modeSelect.value;
    const teammate = teammateSelect.value;

    loading.style.display = 'block';
    noStats.style.display = 'none';
    container.style.display = 'none';

    updateURLParams();

    try {
        let queryParams = `game_type=${gameType}&mode=${mode}`;
        if (teammate) {
            queryParams += `&teammate=${teammate}`;
        }

        // Fetch basic country stats
        const res = await fetch(`/api/v1/countries/?${queryParams}`);
        const data = await res.json();

        if (!data.success) {
            loading.style.display = 'none';
            noStats.style.display = 'block';
            return;
        }

        const allCountries = data.data.all_countries || [];
        const countryStats = allCountries.find(c =>
            c.country_code.toLowerCase() === countryCode.toLowerCase()
        );

        if (!countryStats || countryStats.rounds === 0) {
            loading.style.display = 'none';
            noStats.style.display = 'block';
            return;
        }

        // Render basic stats
        renderBasicStats(countryStats);

        // Fetch detailed analytics
        const detailsRes = await fetch(`/api/v1/countries/${countryCode}/details/?${queryParams}`);
        const detailsJson = await detailsRes.json();

        if (detailsJson.success) {
            detailsData = detailsJson.data;
            renderHeatmap(detailsData.heatmap_data);
            renderWrongGuesses(detailsData.wrong_guesses);
            renderDistanceDistribution(detailsData.distance_distribution);
            renderRegionStats(detailsData.region_stats);
        }

        loading.style.display = 'none';
        container.style.display = 'block';

    } catch (err) {
        loading.innerHTML = `<p class="error">Error loading stats: ${err.message}</p>`;
    }
}

function renderBasicStats(countryStats) {
    const grid = document.getElementById('country-stats-grid');
    const scoreDiffClass = countryStats.avg_score_diff >= 0 ? 'success' : 'error';
    const scoreDiffSign = countryStats.avg_score_diff >= 0 ? '+' : '';

    grid.innerHTML = `
        <div class="stat-card">
            <h3>Total Rounds</h3>
            <p>${countryStats.rounds}</p>
        </div>
        <div class="stat-card">
            <h3>Avg Score</h3>
            <p>${countryStats.avg_score.toFixed(0)}</p>
        </div>
        <div class="stat-card">
            <h3>Avg Distance</h3>
            <p>${countryStats.avg_distance_km.toFixed(1)} km</p>
        </div>
        <div class="stat-card">
            <h3>Score Diff</h3>
            <p class="${scoreDiffClass}">${scoreDiffSign}${countryStats.avg_score_diff.toFixed(0)}</p>
        </div>
        <div class="stat-card">
            <h3>Win Rate</h3>
            <p>${(countryStats.win_rate * 100).toFixed(1)}%</p>
        </div>
        <div class="stat-card">
            <h3>Hit Rate</h3>
            <p>${(countryStats.hit_rate * 100).toFixed(1)}%</p>
        </div>
        <div class="stat-card">
            <h3>5K Rate</h3>
            <p>${(countryStats.five_k_rate * 100).toFixed(1)}%</p>
        </div>
    `;
}

function renderHeatmap(heatmapData) {
    const mapContainer = document.getElementById('heatmap');
    const note = document.getElementById('heatmap-note');

    // Check if we have actual coordinates
    if (heatmapData.actual.length === 0) {
        note.textContent = 'Note: Actual location coordinates are not available for older games. Re-fetch games to populate this data.';
    }

    // Initialize map if not already done
    if (!map) {
        map = L.map('heatmap').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    }

    // Clear existing layers
    if (actualLayer) map.removeLayer(actualLayer);
    if (guessLayer) map.removeLayer(guessLayer);

    // Create marker layers
    const actualMarkers = heatmapData.actual.map(p =>
        L.circleMarker([p.lat, p.lng], {
            radius: 6,
            fillColor: '#00cc66',
            color: '#006633',
            weight: 1,
            opacity: 0.8,
            fillOpacity: 0.6
        })
    );

    const guessMarkers = heatmapData.guess.map(p =>
        L.circleMarker([p.lat, p.lng], {
            radius: 6,
            fillColor: '#ff6b6b',
            color: '#cc0000',
            weight: 1,
            opacity: 0.8,
            fillOpacity: 0.6
        })
    );

    actualLayer = L.layerGroup(actualMarkers);
    guessLayer = L.layerGroup(guessMarkers);

    updateMapLayers();

    // Fit bounds to show all points
    const allPoints = [...heatmapData.actual, ...heatmapData.guess];
    if (allPoints.length > 0) {
        const bounds = L.latLngBounds(allPoints.map(p => [p.lat, p.lng]));
        map.fitBounds(bounds, { padding: [20, 20] });
    }
}

function updateMapLayers() {
    if (!map) return;

    const showActual = document.getElementById('showActual').checked;
    const showGuess = document.getElementById('showGuess').checked;

    if (actualLayer) {
        if (showActual) {
            actualLayer.addTo(map);
        } else {
            map.removeLayer(actualLayer);
        }
    }

    if (guessLayer) {
        if (showGuess) {
            guessLayer.addTo(map);
        } else {
            map.removeLayer(guessLayer);
        }
    }
}

function renderWrongGuesses(wrongGuesses) {
    const container = document.getElementById('wrong-guesses-chart');
    const note = document.getElementById('wrong-guesses-note');

    if (wrongGuesses.length === 0) {
        container.innerHTML = '<p>No wrong guesses recorded - you always guess the correct country!</p>';
        return;
    }

    const maxCount = Math.max(...wrongGuesses.map(w => w.count));

    container.innerHTML = wrongGuesses.map(w => `
        <div class="bar-row">
            <span class="bar-label">${w.country.toUpperCase()}</span>
            <div class="bar-container">
                <div class="bar" style="width: ${(w.count / maxCount) * 100}%"></div>
            </div>
            <span class="bar-value">${w.count}</span>
        </div>
    `).join('');
}

function renderDistanceDistribution(distData) {
    const statsContainer = document.getElementById('distance-stats');
    const chartContainer = document.getElementById('distance-chart');

    // Render stats
    statsContainer.innerHTML = `
        <div class="stat-card">
            <h3>Total Guesses</h3>
            <p>${distData.stats.count}</p>
        </div>
        <div class="stat-card">
            <h3>Average</h3>
            <p>${distData.stats.avg_km.toFixed(1)} km</p>
        </div>
        <div class="stat-card">
            <h3>Median</h3>
            <p>${distData.stats.median_km.toFixed(1)} km</p>
        </div>
        <div class="stat-card">
            <h3>95th Percentile</h3>
            <p>${distData.stats.p95_km.toFixed(1)} km</p>
        </div>
    `;

    // Render bar chart
    const buckets = distData.buckets;
    const bucketOrder = ['0-100m', '100m-1km', '1-10km', '10-50km', '50-200km', '200-1000km', '1000km+'];
    const maxCount = Math.max(...Object.values(buckets));

    chartContainer.innerHTML = bucketOrder.map(bucket => `
        <div class="bar-row">
            <span class="bar-label">${bucket}</span>
            <div class="bar-container">
                <div class="bar distance-bar" style="width: ${maxCount > 0 ? (buckets[bucket] / maxCount) * 100 : 0}%"></div>
            </div>
            <span class="bar-value">${buckets[bucket]}</span>
        </div>
    `).join('');
}

function renderRegionStats(regionStats) {
    const tbody = document.querySelector('#regions-table tbody');
    const note = document.getElementById('regions-note');

    if (regionStats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No region data available. Re-fetch games to populate this data.</td></tr>';
        return;
    }

    // Find max distance for difficulty bar scaling
    const maxDist = Math.max(...regionStats.map(r => r.avg_distance_km));

    tbody.innerHTML = regionStats.map(r => {
        const diffPercent = maxDist > 0 ? (r.avg_distance_km / maxDist) * 100 : 0;
        const diffColor = diffPercent > 66 ? '#cc3333' : diffPercent > 33 ? '#e67e22' : '#00cc66';

        return `
            <tr>
                <td>${r.region}</td>
                <td>${r.rounds}</td>
                <td>${r.avg_distance_km.toFixed(1)} km</td>
                <td>
                    <div class="difficulty-bar-container">
                        <div class="difficulty-bar" style="width: ${diffPercent}%; background: ${diffColor};"></div>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Initialize on page load
async function init() {
    if (initialGameType === 'team_duels') {
        teammateFilter.style.display = 'flex';
        await loadTeammates();
        if (initialTeammate) {
            teammateSelect.value = initialTeammate;
        }
    }
    loadCountryStats();
}

init();
</script>

<style>
/* Heatmap controls */
.heatmap-controls {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.heatmap-controls label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: #ccc;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.actual-dot {
    background: #00cc66;
}

.guess-dot {
    background: #ff6b6b;
}

/* Section description */
.section-desc {
    color: #888;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.note {
    color: #888;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    font-style: italic;
}

/* Bar charts */
.bar-row {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 0.75rem;
}

.bar-label {
    width: 100px;
    text-align: right;
    color: #aaa;
    font-size: 0.9rem;
}

.bar-container {
    flex: 1;
    height: 24px;
    background: #16213e;
    border-radius: 4px;
    overflow: hidden;
}

.bar {
    height: 100%;
    background: #e67e22;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.distance-bar {
    background: #00d9ff;
}

.bar-value {
    width: 50px;
    text-align: left;
    color: #00d9ff;
    font-weight: 600;
}

/* Regions table */
#regions-table {
    margin-top: 1rem;
}

.difficulty-bar-container {
    width: 100%;
    height: 16px;
    background: #16213e;
    border-radius: 4px;
    overflow: hidden;
}

.difficulty-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* Leaflet map dark theme adjustments */
#heatmap {
    background: #16213e;
}

.leaflet-container {
    background: #16213e;
}

/* Section spacing */
#heatmap-section,
#wrong-guesses-section,
#distance-section,
#regions-section {
    margin-top: 2rem;
}
</style>
{% endblock %}
